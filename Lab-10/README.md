# Lab 10 - 綠色小人動畫系統

## 實驗概述

本實驗實作一個綠色小人動畫播放系統，使用雙定時器架構實現動畫控制、七段顯示器掃描和按鍵處理。系統支援動畫播放、時間計數、開始/停止控制，以及速度調整功能。

## 學習目標

- 掌握雙定時器協同工作機制
- 學習中斷優先權設定和管理
- 實作七段顯示器硬體多工掃描
- 理解按鍵防彈跳技術
- 學習動畫播放和速度控制
- 掌握 LCD 點陣圖顯示技術

## 硬體需求

- **微控制器**: NUC100 系列（ARM Cortex-M0）
- **LCD 顯示器**: 用於顯示動畫
- **七段顯示器**: 4 位數，顯示計時器
- **按鍵矩陣**: 3x3 按鍵矩陣
- **開發環境**: Keil MDK-ARM

## 檔案說明

### Q1.c - 基礎版本
- **功能**: 僅支援開始/停止動畫功能
- **按鍵**: 
  - 按鍵 S (5): 開始/停止動畫
- **特點**: 速度控制功能被註解，適合基礎學習

### Q2.c - 完整版本
- **功能**: 支援開始/停止和速度控制
- **按鍵**: 
  - 按鍵 S (5): 開始/停止動畫
  - 按鍵 4: 減速（降低動畫播放速度）
  - 按鍵 6: 加速（提高動畫播放速度）
- **特點**: 完整功能實作，包含速度調整

### Lance_bmp_first.c
- **說明**: 點陣圖處理範例程式

## 功能說明

### 動畫播放
- 系統包含 6 個綠色小人動畫幀（green1 ~ green6）
- 動畫循環播放，形成走路動畫效果
- 停止時顯示紅色停止標誌

### 時間計數
- 七段顯示器顯示動畫播放時間
- 時間單位：0.01 秒（計數器每 10ms 遞增）
- 顯示格式：4 位數（最大 9999，約 99.99 秒）

### 速度控制（僅 Q2）
- 4 個速度等級（speed_index 0-3）
- 速度設定值：200, 100, 50, 25
- 數值越小，動畫切換越快

## 系統架構

### 定時器配置

#### Timer0（動畫控制）
- **頻率**: 100Hz（每 10ms 觸發一次）
- **功能**: 
  - 控制動畫幀切換速度
  - 更新時間計數器
  - 設定 LCD 更新標誌
- **中斷優先權**: 1（較低）

#### Timer1（掃描控制）
- **頻率**: 1kHz（每 1ms 觸發一次）
- **功能**: 
  - 七段顯示器多工掃描（每秒掃描 1000 次）
  - 按鍵掃描和防彈跳（每 20ms 掃描一次）
- **中斷優先權**: 0（最高）

### 變數說明

#### 動畫控制變數
```c
volatile uint32_t animation_counter;  // 動畫計數器
volatile uint32_t time_counter;      // 時間計數器（0.01秒）
volatile uint8_t current_frame;      // 當前動畫幀（0-5）
volatile uint8_t is_running;         // 運行狀態（1=運行，0=停止）
volatile uint8_t speed_index;        // 速度索引（0-3）
volatile uint8_t lcd_update_flag;    // LCD 更新標誌
```

#### 按鍵處理變數
```c
volatile uint8_t key_buffer;  // 按鍵緩衝區
volatile uint8_t key_lock;     // 按鍵鎖定標誌
```

#### 七段顯示器變數
```c
volatile uint8_t seg_digit[4];  // 四位數字陣列
```

## 程式流程

### 初始化流程
1. 系統初始化（SYS_Init）
2. 初始化 Timer0 和 Timer1
3. 開啟七段顯示器和按鍵矩陣
4. 初始化 LCD
5. 設定動畫幀陣列
6. 顯示初始畫面

### 主迴圈流程
```
主迴圈
├── 處理按鍵輸入（Process_Keys）
└── 檢查 LCD 更新標誌
    └── 更新動畫顯示（Update_Animation）
```

### 中斷處理流程

#### Timer0 中斷（動畫控制）
```
Timer0 中斷（每 10ms）
├── 檢查動畫運行狀態
├── 動畫計數器遞增
├── 檢查是否達到速度設定值
│   ├── 切換下一幀
│   ├── 設定 LCD 更新標誌
│   └── 更新時間計數器和七段顯示器數字
└── 清除中斷標誌
```

#### Timer1 中斷（掃描控制）
```
Timer1 中斷（每 1ms）
├── 七段顯示器多工掃描
│   ├── 關閉所有顯示器
│   ├── 顯示當前掃描位置的數字
│   └── 移動到下一個位置
├── 按鍵掃描（每 20ms）
│   ├── 讀取按鍵值
│   ├── 防彈跳處理
│   └── 更新按鍵緩衝區
└── 清除中斷標誌
```

## 按鍵功能表

| 按鍵 | 功能 | Q1 | Q2 |
|------|------|----|----|
| S (5) | 開始/停止動畫 | 支援 | 支援 |
| 4 | 減速 | 不支援 | 支援 |
| 6 | 加速 | 不支援 | 支援 |

## 速度設定對照表

| speed_index | 設定值 | 切換時間 | 說明 |
|-------------|--------|----------|------|
| 0 | 200 | 2.0 秒/幀 | 最慢 |
| 1 | 100 | 1.0 秒/幀 | 慢速（預設） |
| 2 | 50 | 0.5 秒/幀 | 中速 |
| 3 | 25 | 0.25 秒/幀 | 最快 |

## 技術重點

### 1. 雙定時器協同工作
- **Timer0**: 負責動畫控制（100Hz）
- **Timer1**: 負責掃描控制（1kHz）
- 透過中斷優先權確保掃描的即時性

### 2. 中斷優先權管理
- Timer1 優先權 0（最高）：確保掃描不延遲
- Timer0 優先權 1（較低）：動畫控制可稍延遲

### 3. 七段顯示器多工掃描
- 每秒掃描 1000 次（1kHz）
- 每個數字每秒顯示 250 次
- 利用視覺暫留效應形成穩定顯示

### 4. 按鍵防彈跳技術
- 每 20ms 掃描一次按鍵（50Hz）
- 使用 key_lock 防止重複觸發
- 按鍵釋放後才解除鎖定

### 5. 動畫速度控制
- 透過 speed_settings 陣列設定不同速度
- 使用 animation_counter 計數控制切換時機
- 速度調整立即生效

## 常見問題

### Q1: 動畫播放不流暢
- **原因**: Timer0 頻率設定過低或速度設定值過大
- **解決**: 檢查 Timer0 初始化設定和 speed_settings 陣列

### Q2: 七段顯示器閃爍
- **原因**: Timer1 頻率過低或掃描邏輯錯誤
- **解決**: 確保 Timer1 頻率為 1kHz，掃描邏輯正確

### Q3: 按鍵無反應
- **原因**: 按鍵掃描頻率過低或防彈跳邏輯錯誤
- **解決**: 檢查 key_check_counter 計數邏輯和 key_lock 機制

### Q4: 時間計數不準確
- **原因**: Timer0 頻率設定錯誤或計數邏輯錯誤
- **解決**: 確認 Timer0 為 100Hz（每 10ms 觸發一次）

## 相關資源

- **Lab 9**: 貪食蛇遊戲（Timer 中斷應用）
- **Lab 7**: 球體動畫系統（動畫控制）
- **Lab 6**: LCD 顯示控制

## 擴展應用

### 功能擴展
- 添加更多動畫幀（8 幀、12 幀等）
- 實作動畫方向控制（前進/後退）
- 添加音效功能
- 實作動畫暫停/繼續功能

### 技術擴展
- 使用 DMA 加速點陣圖傳輸
- 實作動畫緩衝區機制
- 添加動畫預覽功能
- 實作動畫錄製和回放

## 注意事項

1. **中斷優先權**: 確保 Timer1 優先權高於 Timer0
2. **變數宣告**: 中斷使用的變數必須使用 `volatile` 關鍵字
3. **掃描頻率**: 七段顯示器掃描頻率建議 ≥ 1kHz
4. **按鍵掃描**: 按鍵掃描頻率建議 20-50Hz
5. **記憶體使用**: 點陣圖資料較大，注意記憶體限制

## 版本歷史

- **v1.0**: 初始版本（Q1 基礎功能）
- **v1.1**: 添加速度控制功能（Q2 完整版本）
- **v1.2**: 添加完整註解和文件說明

---

**最後更新**: 2025年  
**狀態**: 完成

